<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DocuAI - Team Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
        --primary-color: #4a69e2; --primary-hover-color: #3b55b5; --secondary-color: #1e293b;
        --text-color: #64748b; --heading-color: #334155; --light-grey: #f1f5f9;
        --white: #ffffff; --border-color: #e2e8f0;
    }
    * { box-sizing: border-box; }
    body {
        margin: 0; font-family: 'Poppins', sans-serif; background-color: #f8fafc;
        display: flex; height: 100vh; color: var(--text-color);
    }
    .sidebar {
        width: 250px; background: linear-gradient(160deg, #1d2b64, #f8cdda);
        color: var(--white); display: flex; flex-direction: column; flex-shrink: 0;
    }
    .sidebar-header {
      padding: 25px; font-size: 24px; font-weight: 600; text-align: center;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .sidebar-content { flex: 1; padding: 15px; text-align: center; font-weight: 300; }
    .sidebar-footer { padding: 25px 15px; }
    #logoutBtn {
        width: 100%; color: var(--secondary-color); background: var(--white); border: none;
        cursor: pointer; font-weight: 500; font-size: 15px; border-radius: 8px; padding: 12px 20px;
        transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 15px;
    }
    #logoutBtn:hover { background-color: var(--light-grey); }
    .main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 30px; }
    h1 { font-size: 28px; font-weight: 600; color: var(--heading-color); margin: 0 0 25px; }
    .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
    .section {
        background: var(--white); padding: 25px; border-radius: 12px;
        border: 1px solid var(--border-color); box-shadow: 0 4px 10px rgba(100, 116, 139, 0.05);
    }
    .section h2 { font-size: 20px; font-weight: 600; color: var(--heading-color); margin: 0 0 20px; }
    .chat-section { grid-column: 1 / -1; }
    .upload-box {
        border: 2px dashed var(--primary-color); border-radius: 10px; padding: 30px;
        text-align: center; background: #f7f9ff;
    }
    .upload-box:hover { background-color: #f1f3fe; }
    .upload-box p { margin: 0 0 15px; }
    .upload-box button {
        background: var(--primary-color); color: var(--white); border: none; cursor: pointer;
        font-weight: 500; font-size: 15px; border-radius: 8px; padding: 10px 20px; margin-top: 10px;
    }
    .status { margin-top: 15px; font-weight: 500; }
    .doc-list { display: flex; flex-direction: column; gap: 10px; }
    .doc-card {
        padding: 12px 16px; border-radius: 8px; background: var(--light-grey);
        border: 1px solid var(--border-color); font-weight: 500; color: var(--secondary-color);
    }
    .messages {
        height: 300px; overflow-y: auto; border: 1px solid var(--border-color);
        padding: 15px; margin-bottom: 15px; background: var(--light-grey); border-radius: 8px;
        display: flex; flex-direction: column; gap: 12px;
    }
    .msg { padding: 10px 15px; border-radius: 18px; max-width: 80%; line-height: 1.5; word-wrap: break-word; }
    .msg.user { background: var(--primary-color); color: var(--white); align-self: flex-end; border-bottom-right-radius: 4px; }
    .msg.bot { background: var(--white); color: var(--secondary-color); border: 1px solid var(--border-color); align-self: flex-start; border-bottom-left-radius: 4px; }
    .chat-input { display: flex; gap: 10px; }
    .chat-input input {
        flex: 1; padding: 12px 16px; font-size: 15px; border-radius: 8px;
        border: 1px solid var(--border-color);
    }
    .chat-input button {
        background: var(--primary-color); color: var(--white); border: none; cursor: pointer;
        font-weight: 500; font-size: 15px; border-radius: 8px; padding: 12px 20px;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header" id="teamNameHeader">Team</div>
    <div class="sidebar-content">
        <p>This is your dedicated workspace. Upload documents and interact with the AI chat below.</p>
    </div>
    <div class="sidebar-footer">
        <button id="logoutBtn">🚪 <span>Logout</span></button>
    </div>
  </div>

  <div class="main">
    <h1 id="mainHeader">Team Dashboard</h1>
    <div class="content-grid">
      <div class="section">
        <h2>Upload Document</h2>
        <form id="uploadForm" class="upload-box">
          <p>Drop a PDF file here to add it to the team's knowledge base.</p>
          <input type="file" id="pdfFile" accept="application/pdf" required />
          <button type="submit">📤 Upload</button>
          <p id="uploadStatus" class="status"></p>
        </form>
      </div>
      <div class="section">
        <h2>Team Documents</h2>
        <div id="docs-container" class="doc-list">Loading documents...</div>
      </div>
      <div class="section chat-section">
        <h2>Chat with Team Documents</h2>
        <div class="chat-box">
          <div class="messages" id="chatMessages"></div>
          <form id="chatForm" class="chat-input">
            <input type="text" id="chatInput" placeholder="Ask about team documents..." autocomplete="off" />
            <button type="submit">Send</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000"; // ✅ fixed
    const companyToken = localStorage.getItem("token");
    const teamData = JSON.parse(sessionStorage.getItem("team_data"));

    if (!companyToken || !teamData) {
        alert("Session invalid. Please log in again.");
        sessionStorage.removeItem("team_data");
        window.location.href = "team.html";
    }

    function displayDocs() {
        const docsDiv = document.getElementById("docs-container");
        docsDiv.innerHTML = "";
        const files = teamData.team_files_name || [];
        if (files.length > 0) {
            files.forEach(doc => {
                const div = document.createElement("div");
                div.className = "doc-card";
                div.textContent = `${doc.pdf_name} (${doc.filename})`;
                docsDiv.appendChild(div);
            });
        } else {
            docsDiv.textContent = "No documents uploaded for this team yet.";
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("teamNameHeader").textContent = teamData.team_name;
        document.getElementById("mainHeader").textContent = `${teamData.team_name}'s Dashboard`;
        displayDocs();
        addMessage(`Hello! I'm ready to answer questions about the documents for team '${teamData.team_name}'.`, "bot");
    });

    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById("pdfFile");
        if (!fileInput.files.length) return;

        const statusEl = document.getElementById("uploadStatus");
        statusEl.textContent = "Uploading, please wait...";

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("team_id", teamData.id);

        try {
            const res = await fetch(`${API_BASE}/team/team_upload`, {
                method: "POST",
                headers: { "X-Token": companyToken },
                body: formData
            });
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.detail || "Upload failed");
            }
            const updatedTeamData = await res.json();
            sessionStorage.setItem("team_data", JSON.stringify(updatedTeamData));
            window.location.reload();
        } catch (err) {
            statusEl.innerText = `❌ Upload failed: ${err.message}`;
        }
    });

    document.getElementById("chatForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const input = document.getElementById("chatInput");
        const message = input.value.trim();
        if (!message) return;

        addMessage(message, "user");
        input.value = "";
        const thinkingMsg = addMessage("Thinking...", "bot");

        const chatFormData = new FormData();
        chatFormData.append("message", message);
        chatFormData.append("team_id", teamData.id);

        try {
            const res = await fetch(`${API_BASE}/team/team_chat`, {
                method: "POST",
                headers: { "X-Token": companyToken },
                body: chatFormData
            });
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.detail || "Failed to get a response");
            }
            const data = await res.json();
            thinkingMsg.innerText = data.answer;
        } catch (err) {
            thinkingMsg.innerText = `Error: ${err.message}`;
        }
    });

    function addMessage(text, sender) {
        const msgDiv = document.createElement("div");
        msgDiv.className = "msg " + sender;
        msgDiv.innerText = text;
        const chatBox = document.getElementById("chatMessages");
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        return msgDiv;
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
        sessionStorage.removeItem("team_data");
        window.location.href = "team.html";
    });
  </script>
</body>
</html>
