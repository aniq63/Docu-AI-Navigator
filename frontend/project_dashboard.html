<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DocuAI - Project Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
        --primary-color: #4a69e2; --primary-hover-color: #3b55b5; --secondary-color: #1e293b;
        --text-color: #64748b; --heading-color: #334155; --light-grey: #f1f5f9;
        --white: #ffffff; --border-color: #e2e8f0;
    }
    * { box-sizing: border-box; }
    body {
        margin: 0; font-family: 'Poppins', sans-serif; background-color: #f8fafc;
        display: flex; height: 100vh; color: var(--text-color);
    }
    .sidebar {
        width: 250px; background: linear-gradient(160deg, #00467F, #A5CC82);
        color: var(--white); display: flex; flex-direction: column; flex-shrink: 0;
    }
    .sidebar-header { padding: 25px; font-size: 24px; font-weight: 600; text-align: center; }
    .sidebar-content { flex: 1; padding: 15px; text-align: center; font-weight: 300; }
    .sidebar-footer { padding: 25px 15px; }
    #logoutBtn {
        width: 100%; color: var(--secondary-color); background: var(--white); border: none;
        cursor: pointer; font-weight: 500; font-size: 15px; border-radius: 8px; padding: 12px 20px;
        transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 15px;
    }
    .main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 30px; }
    h1 { font-size: 28px; font-weight: 600; color: var(--heading-color); margin: 0 0 25px; }
    .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
    .section {
        background: var(--white); padding: 25px; border-radius: 12px;
        border: 1px solid var(--border-color); box-shadow: 0 4px 10px rgba(100, 116, 139, 0.05);
    }
    .section h2 { font-size: 20px; font-weight: 600; color: var(--heading-color); margin: 0 0 20px; }
    .full-width-section { grid-column: 1 / -1; }
    .actions-container {
        grid-column: 1 / -1; display: flex; gap: 15px;
    }
    .action-btn {
        background-color: var(--primary-color); color: var(--white); border: none;
        padding: 12px 20px; font-family: 'Poppins', sans-serif; font-size: 15px;
        font-weight: 500; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;
    }
    .modal {
        display: none; position: fixed; z-index: 1000; left: 0; top: 0;
        width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
        justify-content: center; align-items: center;
    }
    .modal-content {
        background-color: var(--white); padding: 30px; border-radius: 12px;
        width: 600px; max-width: 90%;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h2 { margin: 0; color: var(--heading-color); font-size: 22px; }
    .close-btn { color: var(--text-color); font-size: 28px; font-weight: bold; cursor: pointer; }
    .upload-box { border: 2px dashed var(--primary-color); border-radius: 10px; padding: 30px; text-align: center; }
    .doc-list { display: flex; flex-direction: column; gap: 10px; }
    .doc-card { padding: 12px 16px; border-radius: 8px; background: var(--light-grey); font-weight: 500; }
    .messages { height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: 15px; margin-bottom: 15px; background: var(--light-grey); border-radius: 8px; display: flex; flex-direction: column; gap: 12px; }
    .msg { padding: 10px 15px; border-radius: 18px; max-width: 80%; line-height: 1.5; }
    .msg.user { background: var(--primary-color); color: var(--white); align-self: flex-end; }
    .msg.bot { background: var(--white); border: 1px solid var(--border-color); align-self: flex-start; }
    .chat-input, .plan-form { display: flex; flex-direction: column; gap: 10px; }
    .chat-input { flex-direction: row; }
    input, textarea, button { font-family: 'Poppins', sans-serif; font-size: 15px; }
    .chat-input input, .plan-form input, .plan-form textarea { flex: 1; padding: 12px 16px; border-radius: 8px; border: 1px solid var(--border-color); }
    .chat-input button, .plan-form button, .upload-box button { background: var(--primary-color); color: var(--white); border: none; cursor: pointer; font-weight: 500; border-radius: 8px; padding: 12px 20px; }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header" id="projectNameHeader">Project</div>
    <div class="sidebar-content"><p>Manage project documents, generate AI-powered plans, and chat with your data.</p></div>
    <div class="sidebar-footer"><button id="logoutBtn">üö™ <span>Logout</span></button></div>
  </div>

  <div class="main">
    <h1 id="mainHeader">Project Dashboard</h1>
    <div class="content-grid">
      <div class="actions-container">
        <button id="openPlanModalBtn" class="action-btn">üìù Generate AI Project Plan</button>
      </div>
      <div class="section">
        <h2>Upload Document</h2>
        <form id="uploadForm" class="upload-box">
          <p>Upload a PDF for the project's knowledge base.</p>
          <input type="file" id="pdfFile" accept="application/pdf" required />
          <button type="submit">üì§ Upload</button>
          <p id="uploadStatus" class="status"></p>
        </form>
      </div>
      <div class="section">
        <h2>Project Documents</h2>
        <div id="docs-container" class="doc-list">Loading...</div>
      </div>
      <div class="section full-width-section">
        <h2>Chat with Project Documents</h2>
        <div class="chat-box">
          <div class="messages" id="chatMessages"></div>
          <form id="chatForm" class="chat-input">
            <input type="text" id="chatInput" placeholder="Ask about project documents..." autocomplete="off" />
            <button type="submit">Send</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div id="planModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2>Project Planning Assistant</h2>
              <span class="close-btn" id="closePlanModal">&times;</span>
          </div>
          <form id="planForm" class="plan-form">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                  <input type="text" id="domain" placeholder="Project Domain (e.g., Healthcare)" required />
                  <input type="number" id="membersCount" placeholder="Number of Members" required />
              </div>
              <textarea id="description" placeholder="Project Description" rows="3" required></textarea>
              <textarea id="memberDetails" placeholder="Enter each member on a new line. Format:&#10;Alice - Frontend Developer (React, CSS)&#10;Bob - Backend Developer (FastAPI)" rows="4" required></textarea>
              <input type="text" id="techstack" placeholder="Tech Stack / Tools (e.g., React, FastAPI, Docker)" required />
              <button type="submit" id="generatePlanBtn">Generate Plan</button>
          </form>
      </div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000";
    const companyToken = localStorage.getItem("token");
    const projectData = JSON.parse(sessionStorage.getItem("project_data"));

    if (!companyToken || !projectData) {
        alert("Session invalid. Please log in again.");
        window.location.href = "project.html";
    }
    
    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("projectNameHeader").textContent = projectData.project_name;
        document.getElementById("mainHeader").textContent = `${projectData.project_name}'s Dashboard`;
        displayDocs();
        addMessage(`Hello! I'm ready to assist with project '${projectData.project_name}'.`, "bot");
    });
    
    function displayDocs() {
        const docsDiv = document.getElementById("docs-container");
        docsDiv.innerHTML = "";
        const files = projectData.project_files_name || [];
        if (files.length > 0) {
            files.forEach(doc => {
                const div = document.createElement("div");
                div.className = "doc-card";
                div.textContent = `${doc.pdf_name} (${doc.filename})`;
                docsDiv.appendChild(div);
            });
        } else { docsDiv.textContent = "No documents uploaded yet."; }
    }

    function addMessage(text, sender) {
        const msgDiv = document.createElement("div");
        msgDiv.className = "msg " + sender;
        msgDiv.innerText = text;
        const chatBox = document.getElementById("chatMessages");
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        return msgDiv;
    }

    const planModal = document.getElementById("planModal");
    document.getElementById("openPlanModalBtn").onclick = () => { planModal.style.display = "flex"; };
    document.getElementById("closePlanModal").onclick = () => { planModal.style.display = "none"; };
    window.onclick = (event) => { if (event.target == planModal) planModal.style.display = "none"; };

    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById("pdfFile"), statusEl = document.getElementById("uploadStatus");
        if (!fileInput.files.length) return;
        statusEl.textContent = "Uploading...";
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("project_id", projectData.id);
        try {
            const res = await fetch(`${API_BASE}/project/upload_project_pdf`, {
                method: "POST", headers: { "X-Token": companyToken }, body: formData
            });
            if (!res.ok) throw new Error((await res.json()).detail || "Upload failed");
            const updatedData = await res.json();
            sessionStorage.setItem("project_data", JSON.stringify(updatedData));
            window.location.reload();
        } catch (err) { statusEl.innerText = `‚ùå ${err.message}`; }
    });

    document.getElementById("chatForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const input = document.getElementById("chatInput"), message = input.value.trim();
        if (!message) return;
        addMessage(message, "user");
        input.value = "";
        const thinkingMsg = addMessage("Thinking...", "bot");
        const chatFormData = new FormData();
        chatFormData.append('message', message);
        chatFormData.append('project_id', projectData.id);
        try {
            const res = await fetch(`${API_BASE}/project/project_chat`, {
                method: "POST", headers: { "X-Token": companyToken }, body: chatFormData
            });
            if (!res.ok) throw new Error((await res.json()).detail || "Chat failed");
            const data = await res.json();
            thinkingMsg.innerText = data.answer;
        } catch (err) { thinkingMsg.innerText = `Error: ${err.message}`; }
    });
    
    document.getElementById("planForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const genBtn = document.getElementById("generatePlanBtn");
        genBtn.disabled = true;
        genBtn.textContent = "Generating...";

        const membersText = document.getElementById("memberDetails").value;
        const membersArray = membersText.split('\n').filter(line => line.trim() !== '').map(line => {
            const match = line.match(/([^-\(]+)\s*-\s*([^-\(]+)(?:\((.*)\))?/);
            if (match) {
                const name = match[1].trim();
                const role = match[2].trim();
                const skills = match[3] ? match[3].split(',').map(skill => skill.trim()) : [];
                return { name, role, skills };
            }
            return null;
        }).filter(member => member !== null);

        const project_info = {
            project_description: document.getElementById("description").value,
            no_project_members: parseInt(document.getElementById("membersCount").value),
            project_members: membersArray,
            techstack_or_tool: document.getElementById("techstack").value,
            domain: document.getElementById("domain").value
        };

        try {
            const infoRes = await fetch(`${API_BASE}/project/project_information?project_id=${projectData.id}`, {
                method: "POST",
                headers: { "X-Token": companyToken, "Content-Type": "application/json" },
                body: JSON.stringify(project_info)
            });
            if (!infoRes.ok) throw new Error(`Info Update Failed: ${(await infoRes.json()).detail}`);
            
            const planFormData = new FormData();
            planFormData.append("project_id", projectData.id);
            const planRes = await fetch(`${API_BASE}/project/plan`, {
                method: "POST", headers: { "X-Token": companyToken }, body: planFormData
            });
            if (!planRes.ok) throw new Error(`Plan Generation Failed: ${(await planRes.json()).detail}`);
            
            const planData = await planRes.json();
            
            // Store the generated plan and redirect
            sessionStorage.setItem('generated_plan', JSON.stringify(planData));
            window.location.href = 'plan_view.html';

        } catch (err) {
            alert(`‚ùå Error: ${err.message}`);
            genBtn.disabled = false;
            genBtn.textContent = "Generate Plan";
        }
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
        sessionStorage.removeItem("project_data");
        window.location.href = "project.html";
    });
  </script>
</body>
</html>